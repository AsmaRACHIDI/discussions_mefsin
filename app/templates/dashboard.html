{% extends 'base.html' %}

{% block title %}CategorIA | Dashboard{% endblock %}

{% block content %}
    {% include 'sidebar.html' %}

    <!-- <img src="/static/images/logo.png" alt="Logo" class="logo"> -->
    
    <section class="dashboard">
        <div class="text">Présentation des données annotées par le modèle d'IA</div>
        <div class="table-container">      
            <div id="treemap"></div>
            <script>
                // Charger les données CSV à partir d'un répertoire externe
                d3.csv("/static/data/models_predicted_data.csv").then(function(data) {
                    // Initialiser les compteurs pour chaque catégorie et sous-catégorie
                    var categoryCounts = {};
                    var subcategoryCounts = {};

                    // Compter le nombre d'occurrences de chaque catégorie et sous-catégorie
                    data.forEach(function(d) {
                        var category = d["prediction_motif"];
                        var subcategory = d["prediction_sous_motif"];

                        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                        subcategoryCounts[subcategory] = (subcategoryCounts[subcategory] || 0) + 1;
                    });

                    // Préparer les données pour la treemap
                    var labels = [];
                    var parents = [];
                    var values = [];

                    // Ajouter les catégories avec leur compteur
                    Object.keys(categoryCounts).forEach(function(category) {
                        labels.push(category);
                        parents.push('');
                        values.push(categoryCounts[category]);
                    });

                    // Ajouter les sous-catégories avec leur compteur
                    Object.keys(subcategoryCounts).forEach(function(subcategory) {
                        labels.push(subcategory);
                        // Récupérer la catégorie parente de chaque sous-catégorie
                        var parentCategory = data.find(function(d) {
                            return d["prediction_sous_motif"] === subcategory;
                        })["prediction_motif"];
                        parents.push(parentCategory);
                        values.push(subcategoryCounts[subcategory]);
                    });

                    // Créer la treemap avec Plotly.js
                    var treemapData = [{
                        type: 'treemap',
                        labels: labels,
                        parents: parents,
                        values: values,
                        textinfo: 'label+value'
                    }];

                    var layout = {
                        margin: { t: 60, l: 0, r: 0, b: 0 }, // Ajouter une marge supérieure pour le titre
                        title: {
                            text: "Mosaïque des discussions : Visualisation de l'importance des problèmes rencontrés par catégorie",
                            x: 0.5, // Centrer le titre
                            xanchor: 'center', // Ancrage du titre au centre
                            y: 0.95, // Position verticale du titre
                        }
                    };

                    Plotly.newPlot('treemap', treemapData, layout);

                    // Fonction pour redimensionner la treemap en réponse à un redimensionnement de la fenêtre
                    window.addEventListener('resize', function() {
                        Plotly.relayout('treemap', {
                            width: document.getElementById('treemap').offsetWidth, // Utiliser la largeur de l'élément parent
                            height: window.innerHeight * 0.8 // Mettre à jour la hauteur en fonction de la fenêtre
                        });
                    });
                }).catch(function(error) {
                    console.log(error); // Gérer les éventuelles erreurs de chargement du fichier CSV
                });
            </script>

            <!-- Circle Packing -->
            <div id="circle-packing"></div>
            <!-- <div class="text">Proportion des jeux de données les plus discutés</div> -->
            <script>
                d3.csv("/static/data/models_predicted_data.csv").then(function(data) {
                    // Votre code pour créer le graphique Circle Packing ici
                    // Assurez-vous d'adapter le code pour créer le graphique Circle Packing avec D3.js
                }).catch(function(error) {
                    console.log(error); // Gérer les éventuelles erreurs de chargement du fichier CSV
                });
            </script>
        </div>
    </section>
{% endblock %}
